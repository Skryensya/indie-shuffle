<div class="min-h-screen bg-gradient-to-br from-orange-950 via-slate-950 to-slate-900 relative">
  <!-- Cover Image -->
  <div class="absolute inset-0 z-0">
    <img src="/images/indies-cat.png" alt="Indies Cat" class="w-full h-full object-cover opacity-20" />
    <!-- Dark overlay -->
    <div class="absolute inset-0 bg-slate-900/40"></div>
  </div>
  <div class="relative z-10">
  <!-- Admin Panel Link (discreto en la esquina superior derecha) -->
  <div class="fixed top-2 right-2 z-50">
    <.link navigate="/admin" class="text-xs text-gray-400 hover:text-gray-200 transition-colors">
      <.icon name="hero-cog-6-tooth" class="w-4 h-4" />
    </.link>
  </div>

  <%= if @checking_auth do %>
    <!-- Loading State -->
    <.ui_container id="auth-checker" phx-hook="AuthChecker" class="min-h-screen justify-center">
      <.ui_card class="bg-slate-900/95 backdrop-blur-md border-slate-700">
        <.ui_card_content class="text-center py-12">
          <div class="animate-spin w-12 h-12 border-4 border-orange-200 border-t-orange-600 rounded-full mx-auto mb-4"></div>
          <h2 class="text-xl font-semibold text-white mb-2">Verificando sesi√≥n...</h2>
          <p class="text-gray-400">Un momento por favor</p>
        </.ui_card_content>
      </.ui_card>
    </.ui_container>
  <% else %>
    <%= if !@joined or is_nil(@name) do %>
      <!-- Join Form -->
      <.ui_container class="min-h-screen justify-center">
        <.ui_card class="bg-slate-900/95 backdrop-blur-md border-slate-700">
          <.ui_card_content class="text-center py-12">
            <h1 class="text-4xl font-bold text-white mb-6">
              Indies Shuffle
            </h1>

            <.form for={%{}} phx-submit="set_name" class="space-y-4">
              <input type="hidden" name="token" value={@token || ""} />
              <.ui_input
                name="name"
                placeholder="Tu nombre o handle"
                value={@name || ""}
                autocomplete="off"
                maxlength={40}
                required
                class="bg-slate-700 border-slate-600 text-white placeholder:text-gray-400"
              />
              <.ui_button type="submit" class="w-full">
                Unirse al Lobby
              </.ui_button>
            </.form>

            <%= if @indie_id do %>
              <.ui_badge variant="info" class="mt-4">
                ID: <%= @indie_id %>
              </.ui_badge>
            <% end %>
          </.ui_card_content>
        </.ui_card>
      </.ui_container>
    <% else %>
      <%= if @game_active do %>
        <!-- Game View -->
        <div class="min-h-screen flex items-center justify-center relative p-3">
          <!-- Cover Image Background -->
          <div class="absolute inset-0 z-0">
            <img src="/images/indies-cat.png" alt="Indies Cat" class="w-full h-full object-cover opacity-20" />
            <!-- Dark overlay -->
            <div class="absolute inset-0 bg-slate-900/40"></div>
          </div>

          <div class="max-w-3xl w-full max-h-[700px] relative z-10">
            <div class="bg-slate-900/95 backdrop-blur-md rounded-2xl shadow-xl p-4 border border-slate-700">
              <!-- Emoji del grupo arriba -->
              <div class="text-center mb-3">
                <%= if @game_mode == "together" do %>
                  <div class="text-6xl">üë•</div>
                <% else %>
                  <div class="text-6xl"><%= @my_group.emoji %></div>
                <% end %>
              </div>

              <!-- Timer de Finding Team (si aplica) -->
              <%= if @game_phase == :finding_team do %>
                <div class="bg-gradient-to-br from-orange-500 to-gray-900 rounded-xl shadow-lg mb-3 aspect-[4/3] flex items-center justify-center">
                  <div class="text-center p-6">
                    <h3 class="text-2xl font-bold text-white mb-4">
                      ¬°Encuentra a tu equipo!
                    </h3>
                    <div class="text-6xl font-bold text-white">
                      <%= div(@finding_team_remaining || 0, 1000) %>s
                    </div>
                  </div>
                </div>
              <% end %>

              <!-- Pregunta (solo visible en fase :question) -->
              <%= if @game_phase == :question do %>
                <%= if @my_question do %>
                  <div class="bg-gradient-to-br from-orange-500 to-gray-900 rounded-xl shadow-lg mb-3 aspect-[4/3] flex items-center justify-center">
                    <div class="text-center p-6">
                      <h3 class="text-2xl font-bold text-white leading-relaxed">
                        <%= @my_question %>
                      </h3>
                    </div>
                  </div>
                <% else %>
                  <!-- Mensaje de espera cuando no hay pregunta -->
                  <div class="bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl shadow-lg mb-3 aspect-[4/3] flex items-center justify-center">
                    <div class="text-center p-6">
                      <div class="text-5xl mb-4">‚è≥</div>
                      <h3 class="text-2xl font-bold text-white mb-3">
                        Preparando pregunta...
                      </h3>
                      <p class="text-gray-100 text-sm">
                        La pregunta aparecer√° en un momento
                      </p>
                    </div>
                  </div>
                <% end %>
              <% end %>

              <!-- Lista de miembros del grupo (debajo) -->
              <%
                # Sort members: current user first, then the rest
                sorted_members = Enum.sort_by(@my_group.members, fn member ->
                  if member.indie_id == @indie_id, do: 0, else: 1
                end)
              %>
              <%= if @game_mode == "together" do %>
                <!-- Todos los Participantes -->
                <div class="bg-slate-700/80 backdrop-blur-sm rounded-lg p-3 border border-slate-600">
                  <div class="space-y-1">
                    <%= for member <- sorted_members do %>
                      <div class="flex items-center justify-between px-3 py-2 bg-slate-600/60 rounded">
                        <span class="text-sm font-medium text-gray-100"><%= member.name %></span>
                        <%= if member.indie_id == @indie_id do %>
                          <span class="text-xs text-blue-400 font-semibold">(T√∫)</span>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% else %>
                <!-- Miembros del Grupo -->
                <div class="bg-slate-700/80 backdrop-blur-sm rounded-lg p-3 border border-slate-600">
                  <div class="space-y-1">
                    <%= for member <- sorted_members do %>
                      <div class="flex items-center justify-between px-3 py-2 bg-slate-600/60 rounded">
                        <span class="text-sm font-medium text-gray-100"><%= member.name %></span>
                        <%= if member.indie_id == @indie_id do %>
                          <span class="text-xs text-blue-400 font-semibold">(T√∫)</span>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% else %>
        <!-- Lobby -->
        <.ui_container class="min-h-screen py-8">
          <!-- User Status Card -->
          <.ui_card class="bg-slate-900/95 backdrop-blur-md border-slate-700">
            <.ui_card_content>
              <%= if !@editing do %>
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-4">
                    <.ui_avatar name={@name} size="md" />
                    <div>
                      <h3 class="text-xl font-semibold text-white"><%= @name %></h3>
                      <.ui_badge variant="success">En l√≠nea</.ui_badge>
                    </div>
                  </div>
                  <.ui_button
                    variant="outline"
                    phx-click="edit_name"
                  >
                    <.icon name="hero-pencil" class="w-4 h-4" />
                  </.ui_button>
                </div>
              <% else %>
                <div class="flex items-center space-x-3">
                  <.ui_avatar name={@name} size="md" />
                  <.form for={%{}} phx-submit="set_name" class="flex-1 flex space-x-2 items-center">
                    <input type="hidden" name="token" value={@token} />
                    <.ui_input
                      name="name"
                      value={@name}
                      class="flex-1 bg-slate-700 border-slate-600 text-white"
                      autocomplete="off"
                      maxlength={40}
                      required
                    />
                    <.ui_button type="submit" variant="primary" size="sm">
                      <.icon name="hero-check" class="w-5 h-5" />
                    </.ui_button>
                    <.ui_button
                      type="button"
                      variant="outline"
                      size="sm"
                      phx-click="cancel_edit"
                    >
                      <.icon name="hero-x-mark" class="w-5 h-5" />
                    </.ui_button>
                  </.form>
                </div>
              <% end %>
            </.ui_card_content>
          </.ui_card>

        <!-- Game Status Card -->
        <.ui_card class="bg-slate-900/95 backdrop-blur-md border-slate-700">
          <.ui_card_content>
            <div class="text-center">
              <h2 class="text-2xl font-bold text-white mb-4">Estado del Lobby</h2>

              <%= case @game_state do %>
                <% :waiting -> %>
                  <div class="mb-4">
                    <span class="text-4xl mb-4 block">‚è≥</span>
                    <p class="text-lg text-gray-300 mb-2">Esperando m√°s jugadores</p>
                    <p class="text-sm text-gray-400">
                      Se necesitan <%= @players_needed %> jugador<%= if @players_needed != 1, do: "es" %> m√°s para comenzar
                    </p>
                  </div>
                <% :ready -> %>
                  <div class="mb-4">
                    <span class="text-4xl mb-4 block">‚úÖ</span>
                    <p class="text-lg text-green-400 mb-2">¬°Listo para comenzar!</p>
                    <p class="text-sm text-gray-400">Hay suficientes jugadores para empezar el juego</p>
                  </div>

                  <%= if @can_start_game do %>
                    <.ui_button variant="primary" class="w-full" phx-click="start_game">
                      <.icon name="hero-play" class="w-4 h-4" />
                      Comenzar Juego
                    </.ui_button>
                  <% end %>
                <% :full -> %>
                  <div class="mb-4">
                    <span class="text-4xl mb-4 block">üö´</span>
                    <p class="text-lg text-red-400 mb-2">Lobby lleno</p>
                    <p class="text-sm text-gray-400">El m√°ximo de jugadores ha sido alcanzado</p>
                  </div>
              <% end %>
            </div>
          </.ui_card_content>
        </.ui_card>

        <!-- Players List Card -->
        <.ui_card class="bg-slate-900/95 backdrop-blur-md border-slate-700">
          <.ui_card_content>
            <h3 class="text-lg font-semibold text-white mb-4">
              Jugadores Conectados (<%= length(@players) %>)
            </h3>

            <%= if @players != [] do %>
              <div class="space-y-3">
                <div class="grid gap-3">
                  <%= for %{indie_id: id, name: name} <- @players do %>
                    <div class="flex items-center justify-between p-3 bg-slate-700 rounded-lg">
                      <div class="flex items-center space-x-3">
                        <.ui_avatar name={name || "?"} size="sm" />
                        <span class="font-medium text-gray-100">
                          <%= name || "Usuario sin nombre" %>
                        </span>
                      </div>
                      <%= if id == @indie_id do %>
                        <.ui_badge variant="success">T√∫</.ui_badge>
                      <% else %>
                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
            <% else %>
              <div class="text-center py-8 text-gray-400">
                <span class="text-4xl mb-4 block">üëª</span>
                <p>No hay otros jugadores conectados</p>
                <p class="text-sm mt-2">¬°Comparte el enlace para que se unan m√°s personas!</p>
              </div>
            <% end %>
          </.ui_card_content>
        </.ui_card>

        <!-- Logout Button -->
        <div class="mt-4">
          <.ui_button
            variant="danger"
            phx-click="show_logout_modal"
            class="w-full"
          >
            <.icon name="hero-arrow-right-end-on-rectangle" class="w-4 h-4" />
            Salir del Lobby
          </.ui_button>
        </div>
      </.ui_container>
      <% end %>
    <% end %>
  <% end %>

  <!-- Logout Confirmation Modal -->
  <%= if @show_logout_modal do %>
    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
      <.ui_card class="max-w-md bg-slate-900/95 backdrop-blur-md border-slate-700">
        <.ui_card_content class="text-center p-6">
          <h3 class="text-lg font-semibold text-white mb-4">¬øCerrar sesi√≥n?</h3>
          <p class="text-gray-300 mb-6">¬øEst√°s seguro de que quieres salir del lobby?</p>

          <div class="flex space-x-3 justify-center">
            <.ui_button
              variant="outline"
              phx-click="hide_logout_modal"
            >
              Cancelar
            </.ui_button>
            <.ui_button
              variant="danger"
              phx-click="confirm_logout"
            >
              <.icon name="hero-arrow-right-end-on-rectangle" class="w-4 h-4" />
              Salir
            </.ui_button>
          </div>
        </.ui_card_content>
      </.ui_card>
    </div>
  <% end %>
  </div>
</div>